<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>後台｜考勤系統</title>
<link rel="stylesheet" href="style.css">
<script src="config.js"></script>
<script src="cloud.js"></script>
<style>
*{box-sizing:border-box}body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans',sans-serif;margin:0;background:#f6f7fb;color:#222}
.container{max-width:980px;margin:40px auto;padding:0 16px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:20px;margin-bottom:16px}
h1,h2{margin:0 0 12px}
input,button,select{font-size:16px;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;outline:none}
input:focus,select:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
button{background:#111827;color:#fff;border:0;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-top:1px solid #eee;padding:10px 8px;text-align:left}
.table thead th{border-top:0;color:#6b7280;font-weight:600}
.badge{font-size:12px;color:#6b7280}
.right{margin-left:auto}
.muted{color:#6b7280}
.link{color:#2563eb;cursor:pointer}
</style>

</head>
<body>
<div class="container">
  <div class="card">
    <div class="row"><h1>後台儀表</h1><div class="right"><button id="toPunch">員工打卡頁</button></div></div>
    <div class="row">
      <button id="syncEnable">啟用雲端</button>
      <button id="syncPush">上傳</button>
      <button id="syncPull">下載合併</button>
      <div class="badge right" id="meta">—</div>
    </div>
  </div>

  <div class="card">
    <h2>本月打卡紀錄</h2>
    <div id="records"></div>
  </div>
</div>
<script>
const KEY='yihong_attendance_v1';
const dbLoad=()=>{try{return JSON.parse(localStorage.getItem(KEY)||'{}')}catch(_){return {}}};
const getUser=()=>{try{const j=sessionStorage.getItem('yh_current_user')||localStorage.getItem('yh_current_user_persist');return j?JSON.parse(j):null}catch(_){return null}};
const ymNow=()=>{const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')};

document.getElementById('toPunch').onclick=()=>location.href='punch.html';

document.getElementById('syncEnable').onclick=async()=>alert(await CloudSync.enable()?'OK':'FAIL');
document.getElementById('syncPush').onclick=async()=>alert(await CloudSync.push()?'OK':'FAIL');
document.getElementById('syncPull').onclick=async()=>{const ok=await CloudSync.pull(); if(ok) render(); alert(ok?'OK':'FAIL');};

function render(){
  const db=dbLoad(); const ym=ymNow();
  const recs=(db.records||[]).filter(r=>String(r.ts||'').slice(0,7)===ym).sort((a,b)=>String(b.ts).localeCompare(String(a.ts)));
  let h='<table class="table"><thead><tr><th>時間</th><th>人員</th><th>類型</th><th>店別</th><th>備註</th></tr></thead><tbody>';
  for(const r of recs){
    const name=(db.users||[]).find(x=>x.id===r.userId)?.name||r.userId;
    const shop=(db.shops||[]).find(s=>s.id===r.shopId)?.name||'';
    h+=`<tr><td>${r.ts}</td><td>${name}</td><td>${r.type}</td><td>${shop}</td><td>${r.note||''}</td></tr>`;
  }
  h+='</tbody></table>';
  document.getElementById('records').innerHTML=h;
  document.getElementById('meta').textContent = (db.meta&&db.meta.updatedAt)||'—';
}
render();
</script>
</body>
</html>
